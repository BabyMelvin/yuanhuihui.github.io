### UC代码

    public Class<?> getPluginClass(String packageName, String className)
            throws NameNotFoundException, ClassNotFoundException {
        try {
            Context pluginContext = mContext.createPackageContext(packageName,
                    Context.CONTEXT_INCLUDE_CODE |
                    Context.CONTEXT_IGNORE_SECURITY);
            ClassLoader pluginCL = pluginContext.getClassLoader();
            return pluginCL.loadClass(className);
        }
        catch(NullPointerException e) {
            throw new ClassNotFoundException("Context.createPackageContext() throw NullPointerException.", e);
        }
    }


### 情况

简单说明：
PkgToLoad：被加载的应用，本身无任何操作。
PkgLoader：主Demo，会创建PkgToLoad的Context，并调用context.getClassLoader()。

演示步骤：
1.安装PkgToLoad和PkgLoader
2.运行PkgToLoad和PkgLoader，无顺序要求
3.在最近任务列表或者通过命令行adb shell am force-stop me.rysle.demo.pkgtoload杀掉PkgToLoad
4.观察PkgLoader，也一并被杀

    PkgLoader主要代码：
     private void classLoaderTest() {
        Context otherAppContext = null;
        try {
            otherAppContext = createPackageContext(TARGET, Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY);
            ClassLoader classLoader = otherAppContext.getClassLoader();
            Toast.makeText(this, "获得ClassLoader: " + classLoader, Toast.LENGTH_LONG).show();
        } catch(Exception e) {
            e.printStackTrace();
            Toast.makeText(this, "请先安装PkgToLoad: " + TARGET, Toast.LENGTH_LONG).show();
        }

    }

### 被杀分析


UC被杀的根本原因是采用getClassLoader，从而形成依赖导致被级联杀掉，并非插件机制导致跑到其他进程。
正是由于UC浏览器getClassLoader方法，而该方法内部有这么一行代码：
public ClassLoader getClassLoader() {​
     //获取ClassLoader过程，通过addPackageDependency()添加依赖
     ActivityManagerNative.getDefault().addPackageDependency(mPackageName);​
  }

不管是force-stop还是am kill，杀的核心操作是由killPackageProcessesLocked()来完成的，在该方法内有一个判定：
final boolean isDep = app.pkgDeps != null  && app.pkgDeps.contains(packageName);

杀的过程会遍历有所的进程，对于UID相同的以及含有相同pkgDeps​的进程都会被杀掉。
而UC浏览器调用getClassLoader某个apk的ClassLoader，导致UC浏览器的app.pkgDeps就会包含相应app的包名。
从而杀掉某个app时导致UC浏览器也同事被杀。​


### 查询效果

dumpsys activity p <包名>

可查询情况
